<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fishing Remote Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { touch-action: manipulation; user-select: none; -webkit-user-select: none; }
        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(4px);
            border: 2px solid rgba(255, 255, 255, 0.4);
            transition: all 0.1s;
        }
        .control-btn:active { background: rgba(255, 255, 255, 0.5); transform: scale(0.95); }
        .action-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.5);
        }
        .action-btn:active { background: linear-gradient(135deg, #2563eb, #1d4ed8); transform: scale(0.95); }
        .dpad-row { display: flex; justify-content: center; gap: 15px; }
    </style>
</head>
<body class="bg-slate-900 h-screen w-screen flex flex-col items-center justify-between p-4 overflow-hidden text-white font-bold">

    <!-- Top Bar -->
    <div class="w-full flex justify-between items-center bg-slate-800 p-3 rounded-xl shadow-lg z-10">
        <div>
            <p class="text-xs text-slate-400">STATUS</p>
            <p id="statusText" class="text-sm text-yellow-400">等待連線...</p>
        </div>
        <div class="text-right">
            <p class="text-xs text-slate-400">PLAYER</p>
            <p id="playerName" class="text-sm truncate max-w-[100px]">-</p>
        </div>
    </div>

    <!-- Connection Form -->
    <div id="loginPanel" class="absolute inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center">
        <h1 class="text-3xl mb-6 text-blue-400">釣魚遙控器</h1>
        <input type="text" id="nameInput" placeholder="輸入姓名" class="p-3 rounded bg-slate-800 text-white text-center mb-4 w-64 outline-none border border-slate-600 focus:border-blue-400">
        <button onclick="connect()" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-full text-xl shadow-lg transition">連線</button>
    </div>

    <!-- Main Controls (Hidden until connected & active) -->
    <div id="gameControls" class="hidden flex-col w-full h-full max-w-md justify-between py-4 opacity-50 transition-opacity duration-300">
        
        <!-- D-Pad -->
        <div class="flex-1 flex flex-col justify-center">
            <div class="dpad-row">
                <div class="w-20 h-20 rounded-full control-btn" id="btn-up" data-key="up">
                    <div class="w-full h-full flex items-center justify-center text-2xl">▲</div>
                </div>
            </div>
            <div class="dpad-row mt-4">
                <div class="w-20 h-20 rounded-full control-btn" id="btn-left" data-key="left">
                    <div class="w-full h-full flex items-center justify-center text-2xl">◀</div>
                </div>
                <div class="w-20 h-20 rounded-full control-btn" id="btn-down" data-key="down">
                    <div class="w-full h-full flex items-center justify-center text-2xl">▼</div>
                </div>
                <div class="w-20 h-20 rounded-full control-btn" id="btn-right" data-key="right">
                    <div class="w-full h-full flex items-center justify-center text-2xl">▶</div>
                </div>
            </div>
        </div>

        <!-- Action Button -->
        <div class="flex-1 flex items-center justify-center pb-8">
            <div id="btn-action" class="w-40 h-40 rounded-full action-btn flex items-center justify-center text-2xl text-white shadow-2xl select-none">
                <div class="text-center">
                    <div>CAST</div>
                    <div class="text-sm opacity-80">(ACTION)</div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const WS_URL = 'wss://fishing-ws-server.onrender.com'; // 你的 WebSocket URL
        let ws = null;
        let playerName = '';
        let isConnected = false;
        let isControlActive = false;

        // DOM Elements
        const loginPanel = document.getElementById('loginPanel');
        const gameControls = document.getElementById('gameControls');
        const statusText = document.getElementById('statusText');
        const playerNameDisplay = document.getElementById('playerName');
        const nameInput = document.getElementById('nameInput');

        function connect() {
            playerName = nameInput.value.trim() || 'Student';
            playerNameDisplay.innerText = playerName;
            statusText.innerText = '連線中...';
            statusText.className = 'text-sm text-yellow-400';

            try {
                ws = new WebSocket(WS_URL);

                ws.onopen = () => {
                    isConnected = true;
                    ws.send(JSON.stringify({ type: 'student_join', name: playerName }));
                };

                ws.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    
                    if (msg.type === 'connected') {
                        loginPanel.classList.add('hidden');
                        gameControls.classList.remove('hidden');
                        statusText.innerText = '等待老師選擇...';
                    } 
                    else if (msg.type === 'control_update') {
                        isControlActive = msg.active;
                        if (isControlActive) {
                            statusText.innerText = '輪到你了！';
                            statusText.className = 'text-sm text-green-400 font-bold animate-pulse';
                            gameControls.classList.remove('opacity-50');
                            gameControls.classList.add('opacity-100');
                            // Play sound or vibrate on client side if supported outside WS
                        } else {
                            statusText.innerText = '等待中';
                            statusText.className = 'text-sm text-yellow-400';
                            gameControls.classList.add('opacity-50');
                            gameControls.classList.remove('opacity-100');
                        }
                    }
                    else if (msg.type === 'vibrate') {
                        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                    }
                };

                ws.onclose = () => {
                    isConnected = false;
                    statusText.innerText = '連線斷開 (重連中...)';
                    setTimeout(connect, 3000);
                };

            } catch (e) {
                console.error(e);
                alert('連線失敗');
            }
        }

        // Input Handling
        function sendAction(type, payload = {}) {
            if (!isConnected || !isControlActive) return;
            ws.send(JSON.stringify({ type: 'action', action: type, payload }));
        }

        // Touch/Click Listeners for D-Pad
        const dirButtons = document.querySelectorAll('[data-key]');
        dirButtons.forEach(btn => {
            const handleStart = (e) => {
                e.preventDefault();
                const key = btn.getAttribute('data-key');
                sendAction('aim', { key, active: true });
                if (navigator.vibrate) navigator.vibrate(50);
            };
            const handleEnd = (e) => {
                e.preventDefault();
                const key = btn.getAttribute('data-key');
                sendAction('aim', { key, active: false });
            };

            btn.addEventListener('mousedown', handleStart);
            btn.addEventListener('touchstart', handleStart);
            btn.addEventListener('mouseup', handleEnd);
            btn.addEventListener('touchend', handleEnd);
            btn.addEventListener('mouseleave', handleEnd);
        });

        // Action Button Listener
        const actionBtn = document.getElementById('btn-action');
        const handleActionStart = (e) => {
            e.preventDefault();
            sendAction('interact');
            if (navigator.vibrate) navigator.vibrate(100);
        };
        actionBtn.addEventListener('mousedown', handleActionStart);
        actionBtn.addEventListener('touchstart', handleActionStart);

    </script>
</body>
</html>
