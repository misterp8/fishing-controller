<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ£ é‡£é­šéŠæˆ²æ§åˆ¶å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* æµ·æ´‹ä¸»é¡Œæ¼¸è®ŠèƒŒæ™¯ */
        .ocean-bg {
            background: linear-gradient(180deg, 
                #0c1929 0%, 
                #1a3a5c 30%, 
                #1e5f74 60%, 
                #2a8496 100%);
        }
        
        /* æ°´æ³¢å‹•ç•« */
        @keyframes wave {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .wave-animation {
            animation: wave 3s ease-in-out infinite;
        }
        
        /* æ³¡æ³¡å‹•ç•« */
        @keyframes bubble {
            0% { transform: translateY(0) scale(1); opacity: 0.8; }
            100% { transform: translateY(-100vh) scale(0.5); opacity: 0; }
        }
        
        .bubble {
            position: absolute;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(255,255,255,0.3));
            border-radius: 50%;
            animation: bubble linear forwards;
        }
        
        /* é­šé±—æ•ˆæœ */
        .fish-scale {
            background: radial-gradient(ellipse at center, 
                rgba(34, 211, 238, 0.3) 0%, 
                transparent 70%);
        }
        
        /* æ§åˆ¶æŒ‰éˆ•æ¨£å¼ */
        .control-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.15s ease;
        }
        
        .control-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .control-btn:hover::before {
            left: 100%;
        }
        
        .control-btn:active {
            transform: scale(0.95);
        }
        
        /* æ–¹å‘æŒ‰éˆ•ç‰¹æ®Šæ¨£å¼ */
        .dir-btn {
            background: linear-gradient(145deg, #0891b2, #0e7490);
            box-shadow: 0 4px 15px rgba(8, 145, 178, 0.4);
        }
        
        .dir-btn:hover {
            background: linear-gradient(145deg, #06b6d4, #0891b2);
        }
        
        /* å‹•ä½œæŒ‰éˆ•æ¨£å¼ */
        .action-btn {
            background: linear-gradient(145deg, #059669, #047857);
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);
        }
        
        .action-btn:hover {
            background: linear-gradient(145deg, #10b981, #059669);
        }
        
        .action-btn.cast {
            background: linear-gradient(145deg, #ea580c, #c2410c);
            box-shadow: 0 4px 15px rgba(234, 88, 12, 0.4);
        }
        
        .action-btn.cast:hover {
            background: linear-gradient(145deg, #f97316, #ea580c);
        }
        
        .action-btn.reel {
            background: linear-gradient(145deg, #7c3aed, #6d28d9);
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
        }
        
        .action-btn.reel:hover {
            background: linear-gradient(145deg, #8b5cf6, #7c3aed);
        }
        
        /* å­¸ç”Ÿåˆ—è¡¨æ¨£å¼ */
        .student-item {
            transition: all 0.2s ease;
        }
        
        .student-item:hover {
            transform: translateX(5px);
        }
        
        .student-item.selected {
            background: linear-gradient(90deg, rgba(34, 211, 238, 0.3), transparent);
            border-left: 4px solid #22d3ee;
        }
        
        .student-item.playing {
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.3), transparent);
            border-left: 4px solid #10b981;
        }
        
        .student-item.played {
            opacity: 0.6;
        }
        
        /* ç‹€æ…‹æŒ‡ç¤ºå™¨ */
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .status-dot.connected { background: #10b981; }
        .status-dot.disconnected { background: #ef4444; }
        .status-dot.waiting { background: #f59e0b; }
        
        /* éœ‡å‹•åé¥‹å€åŸŸ */
        .vibration-zone {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
    </style>
</head>
<body class="ocean-bg min-h-screen text-white overflow-hidden">
    <!-- æ³¡æ³¡èƒŒæ™¯ -->
    <div id="bubble-container" class="fixed inset-0 pointer-events-none overflow-hidden z-0"></div>
    
    <div class="relative z-10 flex h-screen">
        <!-- å·¦å´ï¼šå­¸ç”Ÿåˆ—è¡¨ -->
        <div class="w-72 bg-black/30 backdrop-blur-md border-r border-white/10 flex flex-col">
            <div class="p-4 border-b border-white/10">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span>ğŸ‘¥</span> å­¸ç”Ÿåå–®
                </h2>
                <div class="flex items-center gap-2 mt-2">
                    <div id="connection-status" class="status-dot disconnected"></div>
                    <span id="status-text" class="text-sm text-gray-400">æœªé€£ç·š</span>
                    <span id="student-count" class="text-sm text-gray-400 ml-auto">0 äºº</span>
                </div>
            </div>
            
            <!-- æœå°‹æ¡† -->
            <div class="p-3">
                <input type="text" id="search-input" placeholder="æœå°‹å­¸ç”Ÿ..."
                    class="w-full bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-cyan-400 transition-colors">
            </div>
            
            <!-- å­¸ç”Ÿåˆ—è¡¨ -->
            <div id="student-list" class="flex-1 overflow-y-auto p-3 space-y-2">
                <div class="text-center text-gray-500 py-8">ç­‰å¾…å­¸ç”Ÿé€£ç·š...</div>
            </div>
            
            <!-- æ§åˆ¶æŒ‰éˆ• -->
            <div class="p-3 border-t border-white/10 space-y-2">
                <button id="btn-start-selected" disabled
                    class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-600 rounded-lg font-bold disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                    ğŸ® é–‹å§‹é¸å–å­¸ç”Ÿ
                </button>
                
                <div class="grid grid-cols-2 gap-2">
                    <button id="btn-release" disabled
                        class="py-2 bg-gradient-to-r from-orange-500 to-red-500 rounded-lg font-bold text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                        â¹ çµæŸéŠæˆ²
                    </button>
                    <button id="btn-reset-all"
                        class="py-2 bg-gradient-to-r from-gray-600 to-gray-700 rounded-lg font-bold text-sm hover:from-gray-500 hover:to-gray-600">
                        ğŸ”„ é‡ç½®å…¨éƒ¨
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ä¸­é–“ï¼šéŠæˆ²æ§åˆ¶å€åŸŸ -->
        <div class="flex-1 flex flex-col p-4">
            <!-- æ¨™é¡Œ -->
            <div class="text-center mb-4">
                <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-500">
                    ğŸ£ é‡£é­šéŠæˆ²æ§åˆ¶å°
                </h1>
                <p id="current-player" class="text-gray-400 mt-1">ç­‰å¾…é–‹å§‹...</p>
            </div>
            
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="flex-1 flex items-center justify-center">
                <div class="bg-black/20 backdrop-blur-lg rounded-2xl p-6 border border-white/10">
                    <!-- æ–¹å‘æ§åˆ¶ (2x2) -->
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <div></div>
                        <button id="btn-up" data-action="up" data-dir="up"
                            class="control-btn dir-btn w-16 h-16 rounded-xl flex items-center justify-center text-2xl vibration-zone disabled:opacity-50">
                            â¬†ï¸
                        </button>
                        <div></div>
                        
                        <button id="btn-left" data-action="left" data-dir="left"
                            class="control-btn dir-btn w-16 h-16 rounded-xl flex items-center justify-center text-2xl vibration-zone disabled:opacity-50">
                            â¬…ï¸
                        </button>
                        <div class="w-16 h-16 flex items-center justify-center">
                            <div class="w-12 h-12 rounded-full bg-cyan-500/30 flex items-center justify-center">
                                <span class="text-2xl">ğŸ£</span>
                            </div>
                        </div>
                        <button id="btn-right" data-action="right" data-dir="right"
                            class="control-btn dir-btn w-16 h-16 rounded-xl flex items-center justify-center text-2xl vibration-zone disabled:opacity-50">
                            â¡ï¸
                        </button>
                        
                        <div></div>
                        <button id="btn-down" data-action="down" data-dir="down"
                            class="control-btn dir-btn w-16 h-16 rounded-xl flex items-center justify-center text-2xl vibration-zone disabled:opacity-50">
                            â¬‡ï¸
                        </button>
                        <div></div>
                    </div>
                    
                    <!-- å‹•ä½œæŒ‰éˆ• -->
                    <div class="grid grid-cols-2 gap-3">
                        <button id="btn-cast" data-action="cast"
                            class="control-btn action-btn cast py-4 rounded-xl flex flex-col items-center gap-1 vibration-zone disabled:opacity-50">
                            <span class="text-2xl">ğŸ¹</span>
                            <span class="font-bold text-sm">æ‹‹ç«¿</span>
                        </button>
                        <button id="btn-reel" data-action="reel"
                            class="control-btn action-btn reel py-4 rounded-xl flex flex-col items-center gap-1 vibration-zone disabled:opacity-50">
                            <span class="text-2xl">â¬†ï¸</span>
                            <span class="font-bold text-sm">æ”¶ç«¿</span>
                        </button>
                    </div>
                    
                    <!-- ç·Šæ€¥åœæ­¢ -->
                    <button id="btn-emergency-stop"
                        class="w-full mt-3 py-2 bg-red-600/50 hover:bg-red-600/70 rounded-lg text-sm font-bold transition-colors vibration-zone">
                        ğŸ›‘ ç·Šæ€¥åœæ­¢
                    </button>
                </div>
            </div>
            
            <!-- åº•éƒ¨ç‹€æ…‹æ¬„ -->
            <div class="mt-4 flex items-center justify-between text-sm text-gray-400">
                <div class="flex items-center gap-2">
                    <span id="ws-status" class="px-2 py-1 bg-red-500/50 rounded text-xs">WebSocket: é›¢ç·š</span>
                </div>
                <div class="flex items-center gap-4">
                    <span id="vibration-status">éœ‡å‹•: é–‹</span>
                    <span>FPS: <span id="fps">60</span></span>
                </div>
            </div>
        </div>
        
        <!-- å³å´ï¼šæ—¥èªŒ -->
        <div class="w-64 bg-black/20 backdrop-blur-md border-l border-white/10 flex flex-col">
            <div class="p-3 border-b border-white/10">
                <h3 class="font-bold flex items-center gap-2">
                    <span>ğŸ“‹</span> æ´»å‹•æ—¥èªŒ
                </h3>
            </div>
            <div id="log-container" class="flex-1 overflow-y-auto p-3 font-mono text-xs space-y-1">
            </div>
        </div>
    </div>

    <script>
        // ===== é…ç½® =====
        const WS_URL = 'wss://fishing-ws-server.onrender.com';
        const VIBRATION_DURATION = 50; // æ¯«ç§’
        
        // ===== ç‹€æ…‹ =====
        let ws = null;
        let selectedStudentId = null;
        let currentPlayerId = null;
        let vibrationEnabled = true;
        let lastActionTime = 0;
        let frameCount = 0;
        let lastFpsUpdate = Date.now();
        
        // ===== DOM å…ƒç´  =====
        const connectionStatus = document.getElementById('connection-status');
        const statusText = document.getElementById('status-text');
        const studentCount = document.getElementById('student-count');
        const studentList = document.getElementById('student-list');
        const searchInput = document.getElementById('search-input');
        const btnStartSelected = document.getElementById('btn-start-selected');
        const btnRelease = document.getElementById('btn-release');
        const currentPlayer = document.getElementById('current-player');
        const wsStatus = document.getElementById('ws-status');
        const logContainer = document.getElementById('log-container');
        const vibrationStatus = document.getElementById('vibration-status');
        const fpsDisplay = document.getElementById('fps');
        
        // ===== åˆå§‹åŒ–æ³¡æ³¡æ•ˆæœ =====
        function createBubbles() {
            const container = document.getElementById('bubble-container');
            const bubbleCount = 20;
            
            for (let i = 0; i < bubbleCount; i++) {
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                const size = Math.random() * 20 + 5;
                bubble.style.width = `${size}px`;
                bubble.style.height = `${size}px`;
                bubble.style.left = `${Math.random() * 100}%`;
                bubble.style.bottom = '-50px';
                bubble.style.animationDuration = `${Math.random() * 10 + 10}s`;
                bubble.style.animationDelay = `${Math.random() * 10}s`;
                container.appendChild(bubble);
            }
        }
        createBubbles();
        
        // ===== éœ‡å‹•åŠŸèƒ½ =====
        function vibrate(duration = VIBRATION_DURATION) {
            if (!vibrationEnabled) return;
            
            // å˜—è©¦ä½¿ç”¨ Vibration API
            if (navigator.vibrate) {
                navigator.vibrate(duration);
            }
            
            // ä¹Ÿå˜—è©¦è¦–è¦ºåé¥‹ï¼ˆè§¸è¦ºæ¨¡æ“¬ï¼‰
            const btn = event.target.closest('.control-btn');
            if (btn) {
                btn.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    btn.style.transform = '';
                }, 100);
            }
        }
        
        // ===== æ—¥èªŒåŠŸèƒ½ =====
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-gray-300',
                success: 'text-green-400',
                warning: 'text-yellow-400',
                error: 'text-red-400',
                action: 'text-cyan-400'
            };
            
            const div = document.createElement('div');
            div.className = `${colors[type] || 'text-gray-300'} border-l-2 border-white/10 pl-2`;
            div.innerHTML = `<span class="text-gray-500">[${time}]</span> ${message}`;
            logContainer.insertBefore(div, logContainer.firstChild);
            
            // é™åˆ¶æ—¥èªŒæ•¸é‡
            while (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }
        
        // ===== WebSocket é€£ç·š =====
        function connectWebSocket() {
            log('æ­£åœ¨é€£ç·šåˆ°ä¼ºæœå™¨...', 'info');
            
            try {
                ws = new WebSocket(WS_URL);
                
                ws.onopen = () => {
                    log('å·²é€£ç·šåˆ°ä¼ºæœå™¨', 'success');
                    connectionStatus.className = 'status-dot connected';
                    statusText.textContent = 'å·²é€£ç·š';
                    wsStatus.textContent = 'WebSocket: åœ¨ç·š';
                    wsStatus.className = 'px-2 py-1 bg-green-500/50 rounded text-xs';
                    
                    // è¨»å†Šç‚ºè€å¸«
                    ws.send(JSON.stringify({
                        type: 'register',
                        role: 'teacher',
                        name: 'æ§åˆ¶å°'
                    }));
                    
                    updateUI();
                };
                
                ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        handleMessage(message);
                    } catch (err) {
                        log(`è¨Šæ¯è§£æéŒ¯èª¤: ${err.message}`, 'error');
                    }
                };
                
                ws.onclose = () => {
                    log('é€£ç·šå·²æ–·é–‹', 'warning');
                    connectionStatus.className = 'status-dot disconnected';
                    statusText.textContent = 'å·²æ–·ç·š';
                    wsStatus.textContent =WebSocket: é›¢ç·š';
                    wsStatus.className = 'px-2 py-1 bg-red-500/50 rounded text-xs';
                    
                    // å˜—è©¦é‡é€£
                    setTimeout(connectWebSocket, 3000);
                };
                
                ws.onerror = (err) => {
                    log(`WebSocket éŒ¯èª¤: ${err.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                };
                
            } catch (err) {
                log(`é€£ç·šå¤±æ•—: ${err.message}`, 'error');
                setTimeout(connectWebSocket, 3000);
            }
        }
        
        // ===== è™•ç†è¨Šæ¯ =====
        function handleMessage(message) {
            switch (message.type) {
                case 'teacher_registered':
                    log('æ§åˆ¶å°è¨»å†ŠæˆåŠŸ', 'success');
                    if (message.students) {
                        renderStudentList(message.students);
                    }
                    if (message.currentPlayer) {
                        currentPlayerId = message.currentPlayer;
                        updateCurrentPlayer();
                    }
                    break;
                    
                case 'student_list':
                    renderStudentList(message.students);
                    break;
                    
                case 'player_started':
                    currentPlayerId = message.playerId;
                    log(`${message.playerName} é–‹å§‹éŠæˆ²`, 'success');
                    updateCurrentPlayer();
                    updateUI();
                    break;
                    
                case 'player_stopped':
                    log('ç©å®¶åœæ­¢éŠæˆ²', 'warning');
                    currentPlayerId = null;
                    updateCurrentPlayer();
                    updateUI();
                    break;
                    
                case 'player_disconnected':
                    log(`ç©å®¶å·²æ–·ç·š`, 'warning');
                    if (currentPlayerId === message.playerId) {
                        currentPlayerId = null;
                        updateCurrentPlayer();
                    }
                    updateUI();
                    break;
                    
                case 'game_state_update':
                    // åŒæ­¥éŠæˆ²ç‹€æ…‹
                    break;
                    
                case 'error':
                    log(`éŒ¯èª¤: ${message.message}`, 'error');
                    break;
            }
        }
        
        // ===== æ¸²æŸ“å­¸ç”Ÿåˆ—è¡¨ =====
        function renderStudentList(students) {
            const searchTerm = searchInput.value.toLowerCase();
            const filtered = students.filter(s => 
                s.name.toLowerCase().includes(searchTerm) || 
                s.id.toLowerCase().includes(searchTerm)
            );
            
            studentCount.textContent = `${students.length} äºº`;
            
            if (filtered.length === 0) {
                studentList.innerHTML = '<div class="text-center text-gray-500 py-8">æ²’æœ‰ç¬¦åˆçš„å­¸ç”Ÿ</div>';
                return;
            }
            
            studentList.innerHTML = filtered.map(student => {
                let classes = 'student-item flex items-center gap-3 p-3 rounded-lg cursor-pointer ';
                let statusIcon = '';
                
                if (student.isCurrentPlayer) {
                    classes += 'playing';
                    statusIcon = '<span class="text-green-400">ğŸ® éŠæˆ²ä¸­</span>';
                } else if (student.hasPlayed) {
                    classes += 'played bg-white/5';
                    statusIcon = '<span class="text-gray-500">âœ… å·²ç©é</span>';
                } else {
                    classes += 'bg-white/5 hover:bg-white/10';
                    statusIcon = '<span class="text-cyan-400">â³ ç­‰å¾…ä¸­</span>';
                }
                
                if (selectedStudentId === student.id) {
                    classes += ' selected';
                }
                
                return `
                    <div class="${classes}" data-id="${student.id}">
                        <div class="flex-1">
                            <div class="font-bold">${student.name}</div>
                            <div class="text-xs text-gray-400">ID: ${student.id}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-400">${student.playCount} æ¬¡</div>
                            ${statusIcon}
                        </div>
                    </div>
                `;
            }).join('');
            
            // ç¶å®šé»æ“Šäº‹ä»¶
            studentList.querySelectorAll('.student-item').forEach(item => {
                item.addEventListener('click', () => {
                    const id = item.dataset.id;
                    const student = students.find(s => s.id === id);
                    
                    if (student.isCurrentPlayer) return;
                    
                    selectedStudentId = selectedStudentId === id ? null : id;
                    renderStudentList(students);
                    updateUI();
                });
            });
        }
        
        // ===== æ›´æ–°UIç‹€æ…‹ =====
        function updateUI() {
            const hasSelection = selectedStudentId !== null;
            const hasCurrentPlayer = currentPlayerId !== null;
            
            btnStartSelected.disabled = !hasSelection || hasCurrentPlayer;
            btnStartSelected.textContent = hasCurrentPlayer 
                ? 'ğŸ® éŠæˆ²é€²è¡Œä¸­...' 
                : (hasSelection ? 'ğŸ® é–‹å§‹é¸å–å­¸ç”Ÿ' : 'ğŸ‘ˆ è«‹å…ˆé¸å–å­¸ç”Ÿ');
            
            btnRelease.disabled = !hasCurrentPlayer;
            
            // æ§åˆ¶æŒ‰éˆ•ç‹€æ…‹
            const controlBtns = document.querySelectorAll('.control-btn');
            controlBtns.forEach(btn => {
                btn.disabled = !hasCurrentPlayer;
            });
        }
        
        // ===== æ›´æ–°ç•¶å‰ç©å®¶é¡¯ç¤º =====
        function updateCurrentPlayer() {
            if (currentPlayerId) {
                currentPlayer.innerHTML = `<span class="text-green-400">ğŸ® ${currentPlayerId} æ­£åœ¨éŠæˆ²ä¸­</span>`;
            } else {
                currentPlayer.innerHTML = '<span class="text-gray-400">ç­‰å¾…é–‹å§‹...</span>';
            }
        }
        
        // ===== ç™¼é€æ§åˆ¶æŒ‡ä»¤ =====
        function sendAction(action, data = {}) {
            const now = Date.now();
            if (now - lastActionTime < 50) return; // é˜²æ­¢éå¿«é»æ“Š
            lastActionTime = now;
            
            if (!currentPlayerId) {
                log('æ²’æœ‰ç©å®¶åœ¨ç·šä¸Š', 'warning');
                return;
            }
            
            ws.send(JSON.stringify({
                type: 'teacher_command',
                command: 'send_action',
                action: action,
                actionData: data
            }));
            
            log(`${action} ${JSON.stringify(data)}`, 'action');
            vibrate(30);
        }
        
        // ===== äº‹ä»¶ç›£è½ =====
        
        // æœå°‹å­¸ç”Ÿ
        searchInput.addEventListener('input', (e) => {
            const message = { type: 'student_list', students: [] };
            ws.onmessage({ data: JSON.stringify(message) });
        });
        
        // é–‹å§‹é¸å–å­¸ç”Ÿ
        btnStartSelected.addEventListener('click', () => {
            if (!selectedStudentId) return;
            
            ws.send(JSON.stringify({
                type: 'teacher_command',
                command: 'grant_control',
                studentId: selectedStudentId
            }));
            
            log(`æŒ‡å®š ${selectedStudentId} é–‹å§‹éŠæˆ²`, 'success');
            selectedStudentId = null;
        });
        
        // çµæŸéŠæˆ²
        btnRelease.addEventListener('click', () => {
            ws.send(JSON.stringify({
                type: 'teacher_command',
                command: 'release_current'
            }));
            
            log('çµæŸç•¶å‰éŠæˆ²', 'warning');
        });
        
        // é‡ç½®å…¨éƒ¨
        document.getElementById('btn-reset-all').addEventListener('click', () => {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰å­¸ç”Ÿçš„éŠæˆ²ç‹€æ…‹å—ï¼Ÿ')) {
                ws.send(JSON.stringify({
                    type: 'teacher_command',
                    command: 'clear_all'
                }));
                
                log('å·²é‡ç½®æ‰€æœ‰å­¸ç”Ÿ', 'success');
            }
        });
        
        // æ–¹å‘æŒ‰éˆ•
        document.querySelectorAll('[data-dir]').forEach(btn => {
            btn.addEventListener('click', () => {
                const dir = btn.dataset.dir;
                sendAction('move', { direction: dir });
            });
        });
        
        // æ‹‹ç«¿æŒ‰éˆ•
        document.getElementById('btn-cast').addEventListener('click', () => {
            sendAction('cast');
        });
        
        // æ”¶ç«¿æŒ‰éˆ•
        document.getElementById('btn-reel').addEventListener('click', () => {
            sendAction('reel');
        });
        
        // ç·Šæ€¥åœæ­¢
        document.getElementById('btn-emergency-stop').addEventListener('click', () => {
            if (confirm('ç¢ºå®šè¦ç·Šæ€¥åœæ­¢éŠæˆ²å—ï¼Ÿ')) {
                ws.send(JSON.stringify({
                    type: 'teacher_command',
                    command: 'release_current'
                }));
                
                log('ç·Šæ€¥åœæ­¢éŠæˆ²ï¼', 'error');
                vibrate(200);
            }
        });
        
        // éµç›¤æ§åˆ¶
        document.addEventListener('keydown', (e) => {
            if (!currentPlayerId) return;
            
            const keyActions = {
                'ArrowUp': () => sendAction('move', { direction: 'up' }),
                'ArrowDown': () => sendAction('move', { direction: 'down' }),
                'ArrowLeft': () => sendAction('move', { direction: 'left' }),
                'ArrowRight': () => sendAction('move', { direction: 'right' }),
                'Space': () => sendAction('cast'),
                'Enter': () => sendAction('reel')
            };
            
            if (keyActions[e.key]) {
                e.preventDefault();
                keyActions[e.key]();
            }
        });
        
        // éœ‡å‹•é–‹é—œ
        vibrationStatus.addEventListener('click', () => {
            vibrationEnabled = !vibrationEnabled;
            vibrationStatus.textContent = `éœ‡å‹•: ${vibrationEnabled ? 'é–‹' : 'é—œ'}`;
            log(`éœ‡å‹•å·²${vibrationEnabled ? 'é–‹å•Ÿ' : 'é—œé–‰'}`, 'info');
        });
        
        // FPS è¨ˆç®—
        function updateFPS() {
            frameCount++;
            const now = Date.now();
            if (now - lastFpsUpdate >= 1000) {
                fpsDisplay.textContent = frameCount;
                frameCount = 0;
                lastFpsUpdate = now;
            }
            requestAnimationFrame(updateFPS);
        }
        updateFPS();
        
        // ===== å•Ÿå‹• =====
        connectWebSocket();
        
        // åˆå§‹åŒ–æ—¥èªŒ
        log('æ§åˆ¶å°å·²å•Ÿå‹•', 'info');
        log('æ­£åœ¨é€£ç·šåˆ°ä¼ºæœå™¨...', 'info');
    </script>
</body>
</html>
