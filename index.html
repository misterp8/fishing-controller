<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fishing Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { touch-action: none; user-select: none; -webkit-user-select: none; overscroll-behavior: none; }
        
        /* æ–¹å‘ç›¤æ¨£å¼ */
        .d-pad-container {
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            aspect-ratio: 1/1;
            width: 100%;
            max-width: 16rem;
        }
        .d-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(4px);
            transition: background 0.1s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            border-radius: 0.5rem;
        }
        .d-btn:active {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0.92);
        }
        
        /* ä¸»å‹•ä½œæŒ‰éˆ•æ¨£å¼ */
        .action-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            box-shadow: 0 4px 20px rgba(37, 99, 235, 0.5);
            transition: all 0.15s;
        }
        .action-btn:active:not(:disabled) {
            transform: scale(0.95);
            box-shadow: 0 2px 10px rgba(37, 99, 235, 0.4);
        }
        .action-btn:disabled {
            background: #475569;
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .action-btn.alert {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.6);
            animation: pulse-red 1s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="bg-slate-900 text-white h-screen w-screen overflow-hidden flex flex-col font-sans">

    <!-- ç™»å…¥ç•«é¢ -->
    <div id="login-screen" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-slate-900 p-6">
        <h1 class="text-4xl font-bold mb-2 text-blue-400">é‡£é­šé™æ§å™¨</h1>
        <p class="mb-8 text-slate-400">è¼¸å…¥å§“åä»¥åŠ å…¥éŠæˆ²</p>
        <input type="text" id="username" placeholder="ä½ çš„åå­—" 
               class="w-full max-w-xs p-4 rounded-xl bg-slate-800 border border-slate-700 text-xl text-center focus:outline-none focus:border-blue-500 mb-6 text-white">
        <button onclick="connect()" 
                class="w-full max-w-xs py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl text-xl shadow-lg transition-transform active:scale-95">
            é€£ç·š
        </button>
        <p id="status-msg" class="mt-4 text-sm text-red-400 h-6"></p>
    </div>

    <!-- éŠæˆ²æ§åˆ¶ç•«é¢ -->
    <div id="game-screen" class="hidden flex-1 flex-col relative h-full w-full">
        
        <!-- é ‚éƒ¨ç‹€æ…‹åˆ— -->
        <div class="h-16 flex-shrink-0 flex items-center justify-between px-4 bg-slate-800 border-b border-slate-700 shadow-lg z-20">
            <div>
                <span class="text-slate-400 text-xs uppercase tracking-wider">PLAYER</span>
                <div id="display-name" class="font-bold text-lg leading-none pt-1">Guest</div>
            </div>
            <div id="status-badge" class="px-4 py-1.5 rounded-full text-sm font-bold bg-yellow-600 text-yellow-100 animate-pulse shadow-lg">
                ç­‰å¾…é¸å–...
            </div>
        </div>

        <!-- æ§åˆ¶å€åŸŸ -->
        <div class="flex-1 relative flex items-end justify-between px-6 pb-8 z-10">
            
            <!-- å·¦å´ï¼šæ–¹å‘ç›¤ (ä¿®æ­£ç‚ºæ›´ç©©å®šçš„ Grid ä½ˆå±€) -->
            <div class="flex items-center justify-center w-1/2">
                <div class="d-pad-container grid gap-2 w-full max-w-[200px] h-full max-h-[200px]">
                    <div></div>
                    <button ontouchstart="handleInput('UP', true)" ontouchend="handleInput('UP', false)" 
                            onmousedown="handleInput('UP', true)" onmouseup="handleInput('UP', false)" 
                            class="d-btn rounded-t-lg shadow-lg">â–²</button>
                    <div></div>
                    
                    <button ontouchstart="handleInput('LEFT', true)" ontouchend="handleInput('LEFT', false)" 
                            onmousedown="handleInput('LEFT', true)" onmouseup="handleInput('LEFT', false)" 
                            class="d-btn rounded-l-lg shadow-lg">â—€</button>
                    <div class="flex items-center justify-center">
                        <div class="w-8 h-8 bg-slate-700 rounded-full shadow-inner"></div>
                    </div>
                    <button ontouchstart="handleInput('RIGHT', true)" ontouchend="handleInput('RIGHT', false)" 
                            onmousedown="handleInput('RIGHT', true)" onmouseup="handleInput('RIGHT', false)" 
                            class="d-btn rounded-r-lg shadow-lg">â–¶</button>
                    
                    <div></div>
                    <button ontouchstart="handleInput('DOWN', true)" ontouchend="handleInput('DOWN', false)" 
                            onmousedown="handleInput('DOWN', true)" onmouseup="handleInput('DOWN', false)" 
                            class="d-btn rounded-b-lg shadow-lg">â–¼</button>
                    <div></div>
                </div>
            </div>

            <!-- å³å´ï¼šä¸»å‹•ä½œæŒ‰éˆ• (æ•´åˆæ‹‹å‹¾èˆ‡é‡£èµ·) -->
            <div class="flex items-center justify-center w-1/2">
                <button id="main-action-btn" onclick="sendInteract()" disabled
                        class="action-btn w-full max-w-[180px] aspect-square rounded-full flex flex-col items-center justify-center text-white font-bold select-none touch-manipulation">
                    <span class="text-5xl mb-2">ğŸ£</span>
                    <span id="action-text" class="text-2xl">è«‹ç­‰å¾…</span>
                </button>
            </div>

        </div>
    </div>

    <script>
        const WS_URL = 'wss://fishing-ws-server.onrender.com';
        let ws;
        let myName = '';
        let hasControl = false;
        let currentGameState = null;

        function connect() {
            const nameInput = document.getElementById('username');
            myName = nameInput.value.trim();
            const statusMsg = document.getElementById('status-msg');

            if (!myName) {
                statusMsg.innerText = "è«‹è¼¸å…¥å§“å";
                vibrateError();
                return;
            }

            statusMsg.innerText = "é€£ç·šä¸­...";
            statusMsg.className = "mt-4 text-sm text-blue-400 h-6";

            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                ws.send(JSON.stringify({ type: 'JOIN_STUDENT', name: myName }));
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
                document.getElementById('game-screen').classList.add('flex');
                document.getElementById('display-name').innerText = myName;
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'CONTROL_GRANTED') {
                    setControlState(true);
                } else if (data.type === 'CONTROL_REVOKED') {
                    setControlState(false);
                } else if (data.type === 'GAME_STATE_UPDATE') {
                    // æ¥æ”¶éŠæˆ²ç‹€æ…‹æ›´æ–°
                    updateGameStateUI(data.state, data.vibrate);
                }
            };

            ws.onclose = () => {
                alert("é€£ç·šä¸­æ–·ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
                location.reload();
            };

            ws.onerror = (err) => {
                console.error(err);
                statusMsg.innerText = "é€£ç·šå¤±æ•—";
                vibrateError();
            };
        }

        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹èˆ‡æ–‡å­—
        function updateGameStateUI(state, shouldVibrate) {
            currentGameState = state;
            const btn = document.getElementById('main-action-btn');
            const txt = document.getElementById('action-text');

            if (shouldVibrate && hasControl) {
                // éœ‡å‹•æ¨¡å¼ï¼šçŸ­ é•· çŸ­
                navigator.vibrate([200, 100, 200]);
            }

            if (!hasControl) {
                txt.innerText = "è«‹ç­‰å¾…";
                btn.disabled = true;
                btn.className = "action-btn w-full max-w-[180px] aspect-square rounded-full flex flex-col items-center justify-center text-white font-bold select-none touch-manipulation bg-slate-700";
                return;
            }

            // æ ¹æ“šç‹€æ…‹åˆ‡æ›æŒ‰éˆ•
            switch (state) {
                case 'IDLE':
                    txt.innerText = "æ‹‹å‹¾";
                    btn.disabled = false;
                    btn.classList.remove('alert', 'bg-slate-700');
                    break;
                case 'CASTING':
                case 'WAITING':
                    txt.innerText = "ç­‰å¾…ä¸­...";
                    btn.disabled = true;
                    btn.classList.add('bg-slate-700'); // è®Šç°
                    break;
                case 'BITING':
                    txt.innerText = "é‡£èµ·!";
                    btn.disabled = false;
                    btn.classList.remove('bg-slate-700');
                    btn.classList.add('alert'); // å¢åŠ è­¦ç¤ºæ•ˆæœ
                    break;
                case 'REELING':
                case 'REWARD':
                    txt.innerText = "å›æ”¶ä¸­...";
                    btn.disabled = true;
                    btn.classList.remove('alert');
                    btn.classList.add('bg-slate-700');
                    break;
                default:
                    txt.innerText = "æº–å‚™";
                    btn.disabled = true;
            }
        }

        function setControlState(active) {
            hasControl = active;
            const badge = document.getElementById('status-badge');
            
            if (active) {
                badge.innerText = "è¼ªåˆ°ä½ äº†!";
                badge.className = "px-4 py-1.5 rounded-full text-sm font-bold bg-green-600 text-white shadow-lg shadow-green-500/50 border border-green-400";
                // å¦‚æœç²å¾—æ§åˆ¶æ™‚ï¼Œå…ˆé‡ç½® UI ç‚º IDLE (å‡è¨­å‰›æ‹¿åˆ°æ§åˆ¶é€šå¸¸æ˜¯ IDLE)
                updateGameStateUI(currentGameState || 'IDLE', false);
            } else {
                badge.innerText = "æ’éšŠä¸­...";
                badge.className = "px-4 py-1.5 rounded-full text-sm font-bold bg-yellow-600 text-yellow-100 animate-pulse shadow-lg border border-yellow-500";
                updateGameStateUI(null, false);
            }
        }

        // è™•ç†æŒ‰éˆ•æŒ‰ä¸‹
        function sendAction(actionType, payload = {}) {
            if (!hasControl || !ws || ws.readyState !== WebSocket.OPEN) return;
            
            // åªæœ‰åœ¨å…è¨±çš„ç‹€æ…‹ä¸‹æ‰ç™¼é€ INTERACT (é›–ç„¶ Server ä¹Ÿæœ‰æª¢æŸ¥ï¼Œä½†é€™è£¡åšé›™é‡ä¿è­·æ¯”è¼ƒå¥½)
            if (actionType === 'INTERACT') {
                if (currentGameState === 'CASTING' || currentGameState === 'WAITING' || currentGameState === 'REELING') {
                    return; // é€™äº›ç‹€æ…‹ä¸‹ä¸æ‡‰è©²èƒ½æŒ‰
                }
            }

            ws.send(JSON.stringify({
                type: 'GAME_ACTION',
                action: actionType,
                ...payload
            }));
        }

        // ä¸»å‹•ä½œæŒ‰éˆ• (æ‹‹å‹¾/é‡£èµ·)
        function sendInteract() {
            sendAction('INTERACT');
        }

        // æ–¹å‘éµè¼¸å…¥
        function handleInput(direction, isPressed) {
            if (isPressed) {
                sendAction('MOVE_START', { dir: direction });
            } else {
                sendAction('MOVE_END', { dir: direction });
            }
        }

        function vibrateError() {
            if (navigator.vibrate) navigator.vibrate(100);
        }
    </script>
</body>
</html>
