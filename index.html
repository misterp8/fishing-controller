<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fishing Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            touch-action: none; 
            user-select: none; 
            -webkit-user-select: none; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior: none;
            background-color: #0f172a; 
        }
        
        .controller-layout {
            display: flex;
            width: 100%;
            height: 100%;
            padding: 1rem;
            transition: all 0.3s ease;
        }

        /* ==============================
           ç›´å‘æ¨¡å¼ï¼šæŒ‰éˆ•æ”¾å¤§ï¼Œä¸Šä¸‹æ’åˆ—
           ============================== */
        @media (orientation: portrait) {
            .controller-layout {
                flex-direction: column;
                justify-content: center; /* å‚ç›´ç½®ä¸­ï¼Œæ„Ÿè¦ºæ¯”è¼ƒä¸æ“æ“  */
                align-items: center;
                padding-top: 2rem;
                padding-bottom: 2rem;
            }
            
            .d-pad-container {
                width: 90%;       /* ä½”æ»¿å¤§éƒ¨åˆ†å¯¬åº¦ */
                max-width: 380px;  /* å¤§å¹…æ”¾å¤§æœ€å¤§å¯¬é™åˆ¶ */
                margin-bottom: 3rem; /* èˆ‡ä¸‹æ–¹æŒ‰éˆ•çš„é–“è· */
            }

            .d-btn {
                font-size: 3.5rem; /* ç®­é ­åœ–ç¤ºè¶…ç´šå¤§ï¼Œå¥½æŒ‰ */
                border-radius: 0.5rem;
            }
            
            .action-btn-wrapper {
                max-width: 200px; /* é™åˆ¶ä¸‹æ–¹æ‹‹å‹¾æŒ‰éˆ•å¤§å°ï¼Œå¤ªå¤§æœƒæ“‹ä½ä¸Šé¢ */
            }
        }

        /* ==============================
           æ©«å‘æ¨¡å¼ï¼šåŸæœ‰å¤§å°ï¼Œå·¦å³æ’åˆ—
           ============================== */
        @media (orientation: landscape) {
            .controller-layout {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding: 0 4rem;
            }

            .d-pad-container {
                max-width: 200px; 
                aspect-ratio: 1/1;
                margin: 0;
            }
            
            .d-btn {
                font-size: 1.5rem; /* æ©«å‘åœ–ç¤ºå°ä¸€é» */
                border-radius: 0.5rem;
            }
            
            .action-btn-wrapper {
                max-width: 180px;
            }
        }

        /* æ–¹å‘ç›¤é€šç”¨æ¨£å¼ */
        .d-pad-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            touch-action: none; 
        }
        .d-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 3px solid rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: background 0.05s, transform 0.05s; 
        }
        .d-btn:active, .d-btn.active {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(0.92);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .action-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            box-shadow: 0 4px 20px rgba(37, 99, 235, 0.5);
            transition: transform 0.1s;
            cursor: pointer;
            touch-action: none;
        }
        .action-btn:active, .action-btn.active {
            transform: scale(0.95);
            filter: brightness(1.2);
        }
        .action-btn:disabled {
            background: #475569;
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            filter: none;
        }
        
        .action-btn.alert {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.6);
            animation: pulse-red 1s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .status-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ef4444;
            box-shadow: 0 0 5px #ef4444;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .status-light.connected { background-color: #22c55e; box-shadow: 0 0 8px #22c55e; }
    </style>
</head>
<body class="bg-slate-900 text-white h-screen w-screen overflow-hidden flex flex-col font-sans select-none">

    <!-- ç™»å…¥ç•«é¢ -->
    <div id="login-screen" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-slate-900 p-6">
        <div class="mb-6 text-center">
            <div class="text-4xl mb-2">ğŸ£</div>
            <h1 class="text-3xl font-bold mb-1 text-blue-400">é‡£é­šé™æ§å™¨</h1>
        </div>
        <p class="mb-8 text-slate-400">è«‹è¼¸å…¥å§“åä»¥é€²å…¥æ•™å®¤</p>
        <input type="text" id="username" placeholder="ä½ çš„åå­—" 
               class="w-full max-w-xs p-4 rounded-xl bg-slate-800 border border-slate-700 text-xl text-center focus:outline-none focus:border-blue-500 mb-6 text-white">
        <button onclick="connect()" 
                class="w-full max-w-xs py-4 bg-blue-600 hover:bg-blue-500 active:bg-blue-700 text-white font-bold rounded-xl text-xl shadow-lg transition-all select-none">
            é€£ç·š
        </button>
        <p id="status-msg" class="mt-4 text-sm text-red-400 h-6"></p>
        
        <div class="fixed top-4 right-4 flex items-center gap-2 bg-slate-800 px-3 py-1 rounded-full border border-slate-700">
            <div id="connect-light" class="status-light"></div>
            <span id="connect-text" class="text-xs text-slate-400">æœªé€£ç·š</span>
        </div>
    </div>

    <!-- éŠæˆ²æ§åˆ¶ç•«é¢ -->
    <div id="game-screen" class="hidden flex-1 flex-col relative h-full w-full">
        
        <div class="h-16 flex-shrink-0 flex items-center justify-between px-4 bg-slate-800 border-b border-slate-700 shadow-lg z-20">
            <div>
                <span class="text-slate-400 text-xs uppercase tracking-wider block mb-0.5">PLAYER</span>
                <div id="display-name" class="font-bold text-lg leading-none">Guest</div>
            </div>
            <div id="status-badge" class="px-4 py-1.5 rounded-full text-sm font-bold bg-yellow-600 text-yellow-100 animate-pulse shadow-lg">
                ç­‰å¾…é¸å–...
            </div>
            <div class="flex items-center gap-2">
                <div id="game-connect-light" class="status-light"></div>
            </div>
        </div>

        <!-- ä½ˆå±€å®¹å™¨ -->
        <div class="controller-layout z-10 flex-1">
            
            <!-- å·¦å´/ä¸Šæ–¹ï¼šæ–¹å‘ç›¤ -->
            <div class="flex justify-center items-center flex-1 w-full">
                <div class="d-pad-container grid gap-3">
                    <div></div>
                    <button id="btn-up" class="d-btn rounded-t-xl shadow-lg select-none">â–²</button>
                    <div></div>
                    
                    <button id="btn-left" class="d-btn rounded-l-xl shadow-lg select-none">â—€</button>
                    <div class="flex items-center justify-center bg-slate-800/20 rounded-xl">
                        <div class="w-8 h-8 bg-slate-700 rounded-full shadow-inner"></div>
                    </div>
                    <button id="btn-right" class="d-btn rounded-r-xl shadow-lg select-none">â–¶</button>
                    
                    <div></div>
                    <button id="btn-down" class="d-btn rounded-b-xl shadow-lg select-none">â–¼</button>
                    <div></div>
                </div>
            </div>

            <!-- å³å´/ä¸‹æ–¹ï¼šä¸»å‹•ä½œæŒ‰éˆ• -->
            <div class="flex justify-center items-center flex-1 w-full action-btn-wrapper">
                <button id="main-action-btn" disabled
                        class="action-btn w-full aspect-square rounded-full flex flex-col items-center justify-center text-white font-bold select-none active:scale-95 transition-transform">
                    <span class="text-5xl mb-2 select-none">ğŸ£</span>
                    <span id="action-text" class="text-xl md:text-2xl select-none">è«‹ç­‰å¾…</span>
                </button>
            </div>

        </div>
    </div>

    <script>
        const WS_URL = 'wss://fishing-ws-server.onrender.com';
        let ws;
        let myName = '';
        let hasControl = false;
        let currentGameState = null; 

        function updateConnectionStatus(connected) {
            const lights = [document.getElementById('connect-light'), document.getElementById('game-connect-light')];
            const text = document.getElementById('connect-text');
            lights.forEach(l => connected ? l.classList.add('connected') : l.classList.remove('connected'));
            if(text) text.innerText = connected ? "é€£ç·šä¸­" : "æ–·ç·š";
        }

        function connect() {
            const nameInput = document.getElementById('username');
            myName = nameInput.value.trim();
            const statusMsg = document.getElementById('status-msg');

            if (!myName) {
                statusMsg.innerText = "è«‹è¼¸å…¥å§“å";
                // [ä¿®æ”¹] å¦‚æœéœ‡å‹•æ”¯æ´ï¼Œè¼¸å…¥æ¡†éŒ¯èª¤æ™‚éœ‡å‹•ä¸€ä¸‹æé†’
                if (navigator.vibrate) navigator.vibrate(100);
                return;
            }

            statusMsg.innerText = "é€£ç·šä¸­...";
            statusMsg.className = "mt-4 text-sm text-blue-400 h-6";

            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                updateConnectionStatus(true);
                // [æ–°å¢] é€£ç·šæˆåŠŸéœ‡å‹•åé¥‹
                if (navigator.vibrate) navigator.vibrate(200);
                
                ws.send(JSON.stringify({ type: 'JOIN_STUDENT', name: myName }));
                
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
                document.getElementById('game-screen').classList.add('flex');
                document.getElementById('display-name').innerText = myName;
                
                setupInputs(); 
                updateGameStateUI(null); 
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'CONTROL_GRANTED') {
                    console.log("Control Granted");
                    setControlState(true);
                    sendMove('UP', false); 
                    sendMove('DOWN', false);
                    sendMove('LEFT', false);
                    sendMove('RIGHT', false);
                } else if (data.type === 'CONTROL_REVOKED') {
                    setControlState(false);
                } else if (data.type === 'GAME_STATE_UPDATE') {
                    updateGameStateUI(data.state, data.vibrate);
                }
            };

            ws.onclose = () => {
                updateConnectionStatus(false);
                if(ws.readyState === WebSocket.CLOSED) {
                    // [ä¿®æ”¹] æ–·ç·šæ™‚çµ¦äºˆéœ‡å‹•æç¤º
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                    alert("é€£ç·šå·²æ–·é–‹ï¼Œè«‹é‡æ–°æ•´ç†");
                    location.reload();
                }
            };

            ws.onerror = (err) => {
                console.error(err);
                updateConnectionStatus(false);
                statusMsg.innerText = "é€£ç·šå¤±æ•—";
            };
        }

        function setupInputs() {
            const directions = {
                'btn-up': 'UP',
                'btn-down': 'DOWN',
                'btn-left': 'LEFT',
                'btn-right': 'RIGHT'
            };

            for (const [id, dir] of Object.entries(directions)) {
                const btn = document.getElementById(id);
                
                function handleStart(e) {
                    e.preventDefault(); 
                    // [æ–°å¢] æ–¹å‘éµæŒ‰ä¸‹çš„æ¥µçŸ­è§¸è¦ºå›é¥‹
                    if (navigator.vibrate) navigator.vibrate(25);
                    
                    sendMove(dir, true);
                    btn.classList.add('active'); 
                    e.target.setPointerCapture(e.pointerId); 
                }

                function handleEnd(e) {
                    e.preventDefault();
                    sendMove(dir, false);
                    btn.classList.remove('active');
                    e.target.releasePointerCapture(e.pointerId);
                }

                btn.addEventListener('pointerdown', handleStart);
                btn.addEventListener('pointerup', handleEnd);
                btn.addEventListener('pointercancel', handleEnd); 
                btn.addEventListener('pointerleave', handleEnd);   
            }

            const actionBtn = document.getElementById('main-action-btn');
            
            function handleActionClick(e) {
                e.preventDefault(); 
                // [æ–°å¢] ä¸»å‹•ä½œæŒ‰éˆ•æŒ‰ä¸‹çš„è§¸è¦ºå›é¥‹ (æ¯”æ–¹å‘éµç¨é•·ä¸€é»ï¼Œæ›´æœ‰æ‰‹æ„Ÿ)
                if (navigator.vibrate) navigator.vibrate(50);

                actionBtn.classList.add('active');
                sendInteract(); 
                setTimeout(() => actionBtn.classList.remove('active'), 200); 
            }
            
            actionBtn.addEventListener('pointerdown', handleActionClick);
        }

        function updateGameStateUI(state, shouldVibrate) {
            if (state !== undefined) {
                currentGameState = state;
            }

            // [ä¿®æ”¹] å’¬é¤Œéœ‡å‹•æ¨¡å¼ï¼šé›™éœ‡æ¨¡å¼ (éœ‡-åœ-éœ‡)ï¼Œæ›´æœ‰è¡æ“ŠåŠ›
            if (shouldVibrate && hasControl && navigator.vibrate) {
                navigator.vibrate([300, 100, 300]);
            }

            const btn = document.getElementById('main-action-btn');
            const txt = document.getElementById('action-text');

            if (!hasControl) {
                txt.innerText = "æ’éšŠä¸­...";
                btn.disabled = true;
                btn.className = "action-btn w-full aspect-square rounded-full flex flex-col items-center justify-center text-white font-bold select-none active:scale-95 transition-transform bg-slate-700";
                return;
            }

            const renderState = currentGameState || 'IDLE';

            switch (renderState) {
                case 'IDLE':
                    txt.innerText = "æ‹‹å‹¾";
                    btn.disabled = false;
                    btn.classList.remove('alert', 'bg-slate-700');
                    break;
                case 'CASTING':
                case 'WAITING':
                    txt.innerText = "ç­‰å¾…ä¸­...";
                    btn.disabled = true;
                    btn.classList.add('bg-slate-700'); 
                    break;
                case 'BITING':
                    txt.innerText = "é‡£èµ·!";
                    btn.disabled = false;
                    btn.classList.remove('bg-slate-700');
                    btn.classList.add('alert');
                    break;
                case 'REELING':
                case 'REWARD':
                    txt.innerText = "å›æ”¶ä¸­...";
                    btn.disabled = true;
                    btn.classList.remove('alert');
                    btn.classList.add('bg-slate-700');
                    break;
                default:
                    txt.innerText = "æº–å‚™";
                    btn.disabled = true;
            }
        }

        function setControlState(active) {
            hasControl = active;
            const badge = document.getElementById('status-badge');
            if (active) {
                badge.innerText = "è¼ªåˆ°ä½ äº†!";
                badge.className = "px-4 py-1.5 rounded-full text-sm font-bold bg-green-600 text-white shadow-lg shadow-green-500/50 border border-green-400 transition-all";
                // [æ–°å¢] è¼ªåˆ°è‡ªå·±æ™‚ï¼Œè¼•éœ‡æé†’
                if (navigator.vibrate) navigator.vibrate(200);
                updateGameStateUI(null, false);
            } else {
                badge.innerText = "æ’éšŠä¸­...";
                badge.className = "px-4 py-1.5 rounded-full text-sm font-bold bg-yellow-600 text-yellow-100 animate-pulse shadow-lg border border-yellow-500 transition-all";
                updateGameStateUI(null, false);
            }
        }

        function sendMove(dir, isPressed) {
            if (!hasControl || !ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({
                type: 'GAME_ACTION',
                action: isPressed ? 'MOVE_START' : 'MOVE_END',
                dir: dir
            }));
        }

        function sendInteract() {
            if (!hasControl || !ws || ws.readyState !== WebSocket.OPEN) return;
            
            ws.send(JSON.stringify({
                type: 'GAME_ACTION',
                action: 'INTERACT'
            }));
        }
    </script>
</body>
</html>
