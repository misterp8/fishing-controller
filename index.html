<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ£ é‡£é­šé™æ§å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        body { margin: 0; overflow: hidden; background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 50%, #0f172a 100%); }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .ctrl-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.1s;
        }
        .ctrl-btn:active { transform: scale(0.95); }
        .ctrl-btn.active { background: linear-gradient(145deg, #10b981, #059669); box-shadow: 0 0 20px rgba(16, 185, 129, 0.5); }
        
        /* æ–¹å‘æŒ‰éˆ• */
        .dir-btn {
            background: linear-gradient(145deg, #0891b2, #0e7490);
            box-shadow: 0 4px 15px rgba(8, 145, 178, 0.4);
        }
        .dir-btn:hover { background: linear-gradient(145deg, #06b6d4, #0891b2); }
        
        /* å‹•ä½œæŒ‰éˆ• */
        .cast-btn { background: linear-gradient(145deg, #ea580c, #c2410c); box-shadow: 0 4px 15px rgba(234, 88, 12, 0.4); }
        .cast-btn:hover { background: linear-gradient(145deg, #f97316, #ea580c); }
        
        .reel-btn { background: linear-gradient(145deg, #7c3aed, #6d28d9); box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4); }
        .reel-btn:hover { background: linear-gradient(145deg, #8b5cf6, #7c3aed); }
        
        /* ç‹€æ…‹æŒ‡ç¤ºå™¨ */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; animation: pulse 2s infinite; }
        .status-dot.connected { background: #10b981; }
        .status-dot.disconnected { background: #ef4444; }
        .status-dot.waiting { background: #f59e0b; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* é­šé°­å‹•ç•« */
        .fin-animation { animation: fin-wag 0.5s ease-in-out infinite alternate; }
        @keyframes fin-wag { from { transform: rotate(-10deg); } to { transform: rotate(10deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col text-white">
    <!-- é ‚éƒ¨ç‹€æ…‹æ¬„ -->
    <div class="p-4 bg-black/30 backdrop-blur-md">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div id="status-dot" class="status-dot disconnected"></div>
                <span id="status-text" class="font-bold">é€£ç·šä¸­...</span>
            </div>
            <div class="text-right">
                <div id="my-id" class="text-xs text-gray-400">--</div>
                <div id="player-name" class="text-sm text-cyan-400">ç­‰å¾…é€£ç·š...</div>
            </div>
        </div>
    </div>
    
    <!-- ä¸»è¦å…§å®¹ -->
    <div class="flex-1 flex items-center justify-center p-4">
        <div class="bg-black/40 backdrop-blur-lg rounded-3xl p-6 border border-white/10">
            <!-- é­šåœ–ç¤º -->
            <div class="text-center mb-6">
                <div class="inline-block text-8xl relative">
                    <span class="fin-animation absolute -top-2 -left-3 text-4xl">ğŸŸ</span>
                    ğŸ£
                    <span class="fin-animation absolute -bottom-2 -right-3 text-4xl transform scale-x-[-1]">ğŸŸ</span>
                </div>
                <p id="game-status" class="mt-2 text-gray-400">ç­‰å¾…è€å¸«æŒ‡æ´¾...</p>
            </div>
            
            <!-- æ§åˆ¶å€åŸŸ -->
            <div id="control-area" class="opacity-50 pointer-events-none">
                <!-- æ–¹å‘æ§åˆ¶ -->
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <div></div>
                    <button id="btn-up" data-action="move" data-dir="up" class="ctrl-btn dir-btn w-16 h-16 rounded-xl text-2xl flex items-center justify-center">â¬†ï¸</button>
                    <div></div>
                    
                    <button id="btn-left" data-action="move" data-dir="left" class="ctrl-btn dir-btn w-16 h-16 rounded-xl text-2xl flex items-center justify-center">â¬…ï¸</button>
                    <div class="w-16 h-16 flex items-center justify-center">
                        <div class="w-12 h-12 rounded-full bg-cyan-500/30 flex items-center justify-center">
                            <span class="text-2xl">ğŸ£</span>
                        </div>
                    </div>
                    <button id="btn-right" data-action="move" data-dir="right" class="ctrl-btn dir-btn w-16 h-16 rounded-xl text-2xl flex items-center justify-center">â¡ï¸</button>
                    
                    <div></div>
                    <button id="btn-down" data-action="move" data-dir="down" class="ctrl-btn dir-btn w-16 h-16 rounded-xl text-2xl flex items-center justify-center">â¬‡ï¸</button>
                    <div></div>
                </div>
                
                <!-- å‹•ä½œæŒ‰éˆ• -->
                <div class="grid grid-cols-2 gap-3">
                    <button id="btn-cast" data-action="cast" class="ctrl-btn cast-btn py-4 rounded-xl flex flex-col items-center gap-1">
                        <span class="text-2xl">ğŸ¹</span>
                        <span class="font-bold text-sm">æ‹‹ç«¿</span>
                    </button>
                    <button id="btn-reel" data-action="reel" class="ctrl-btn reel-btn py-4 rounded-xl flex flex-col items-center gap-1">
                        <span class="text-2xl">â¬†ï¸</span>
                        <span class="font-bold text-sm">æ”¶ç«¿</span>
                    </button>
                </div>
            </div>
            
            <!-- æœªç²å¾—æ§åˆ¶æ¬Šæ™‚çš„æç¤º -->
            <div id="waiting-area" class="text-center py-4">
                <div class="inline-flex items-center gap-2 px-4 py-2 bg-yellow-500/20 rounded-full">
                    <div class="w-2 h-2 bg-yellow-400 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-yellow-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-2 h-2 bg-yellow-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <span class="text-sm text-yellow-400">ç­‰å¾…è€å¸«æŒ‡æ´¾...</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åº•éƒ¨èªªæ˜ -->
    <div class="p-4 text-center text-xs text-gray-500">
        <p>ğŸ® é»æ“ŠæŒ‰éˆ•æ§åˆ¶é‡£é­šéŠæˆ²</p>
        <p class="mt-1">æ”¯æ´æ‰‹æ©Ÿéœ‡å‹•å›é¥‹</p>
    </div>

    <script>
        // ===== é…ç½® =====
        const WS_URL = 'wss://fishing-ws-server.onrender.com';
        
        // ===== ç‹€æ…‹ =====
        let ws = null;
        let myId = null;
        let isController = false;
        let vibrationEnabled = true;
        
        // ===== DOM å…ƒç´  =====
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const myIdEl = document.getElementById('my-id');
        const playerName = document.getElementById('player-name');
        const gameStatus = document.getElementById('game-status');
        const controlArea = document.getElementById('control-area');
        const waitingArea = document.getElementById('waiting-area');
        
        // ===== é€£ç·šç®¡ç† =====
        function connect() {
            updateStatus('connecting', 'é€£ç·šä¸­...');
            ws = new WebSocket(WS_URL);
            
            ws.onopen = () => {
                console.log('WebSocket é€£ç·šæˆåŠŸ');
                updateStatus('connected', 'å·²é€£ç·š');
                ws.send(JSON.stringify({ type: 'register', role: 'student' }));
            };
            
            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                handleMessage(msg);
            };
            
            ws.onclose = () => {
                console.log('é€£ç·šä¸­æ–·');
                updateStatus('disconnected', 'é€£ç·šä¸­æ–·ï¼Œ3ç§’å¾Œé‡é€£...');
                isController = false;
                updateControlState();
                setTimeout(connect, 3000);
            };
            
            ws.onerror = (err) => {
                console.error('WebSocket éŒ¯èª¤:', err);
                updateStatus('disconnected', 'é€£ç·šéŒ¯èª¤');
            };
        }
        
        function handleMessage(msg) {
            console.log('æ”¶åˆ°:', msg.type);
            
            switch (msg.type) {
                case 'connected':
                    myId = msg.yourId;
                    myIdEl.textContent = `ID: ${myId}`;
                    playerName.textContent = `å­¸ç”Ÿ_${myId}`;
                    break;
                    
                case 'student_registered':
                    myId = msg.yourId;
                    myIdEl.textContent = `ID: ${myId}`;
                    playerName.textContent = `å­¸ç”Ÿ_${myId}`;
                    updateStatus('waiting', msg.waiting ? 'ç­‰å¾…ä¸­...' : 'æº–å‚™å°±ç·’');
                    break;
                    
                case 'control_busy':
                    updateStatus('waiting', `${msg.currentController} æ­£åœ¨ç©`);
                    break;
                    
                case 'control_granted':
                    isController = true;
                    playerName.textContent = 'ğŸ® æˆ‘æ­£åœ¨æ§åˆ¶ï¼';
                    gameStatus.textContent = 'è¼ªåˆ°æˆ‘ç©äº†ï¼';
                    updateControlState();
                    vibrate(100);
                    break;
                    
                case 'control_released':
                    isController = false;
                    playerName.textContent = `å­¸ç”Ÿ_${myId}`;
                    gameStatus.textContent = 'ç­‰å¾…è€å¸«æŒ‡æ´¾...';
                    updateControlState();
                    break;
            }
        }
        
        function updateStatus(status, text) {
            statusDot.className = `status-dot ${status}`;
            statusText.textContent = text;
        }
        
        function updateControlState() {
            if (isController) {
                controlArea.classList.remove('opacity-50', 'pointer-events-none');
                waitingArea.style.display = 'none';
            } else {
                controlArea.classList.add('opacity-50', 'pointer-events-none');
                waitingArea.style.display = 'block';
            }
        }
        
        function sendAction(action, data = {}) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({ type: 'game_action', action, data }));
        }
        
        // ===== éœ‡å‹•åŠŸèƒ½ =====
        function vibrate(ms = 50) {
            if (!vibrationEnabled) return;
            if (navigator.vibrate) {
                navigator.vibrate(ms);
            }
        }
        
        // ===== æŒ‰éˆ•äº‹ä»¶ =====
        function handleBtnClick(e) {
            if (!isController) return;
            
            const btn = e.currentTarget;
            const action = btn.dataset.action;
            const dir = btn.dataset.dir;
            
            // è¦–è¦ºåé¥‹
            btn.classList.add('active');
            setTimeout(() => btn.classList.remove('active'), 100);
            
            // éœ‡å‹•
            vibrate(30);
            
            // ç™¼é€å‹•ä½œ
            if (action === 'move') {
                sendAction('move', { direction: dir });
            } else {
                sendAction(action);
            }
            
            console.log('ç™¼é€:', action, dir || '');
        }
        
        // ç¶å®šæ‰€æœ‰æŒ‰éˆ•
        document.querySelectorAll('.ctrl-btn').forEach(btn => {
            btn.addEventListener('click', handleBtnClick);
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleBtnClick(e);
            });
        });
        
        // éµç›¤æ§åˆ¶
        document.addEventListener('keydown', (e) => {
            if (!isController) return;
            
            const keyMap = {
                'ArrowUp': () => { document.getElementById('btn-up').click(); },
                'ArrowDown': () => { document.getElementById('btn-down').click(); },
                'ArrowLeft': () => { document.getElementById('btn-left').click(); },
                'ArrowRight': () => { document.getElementById('btn-right').click(); },
                ' ': () => { document.getElementById('btn-cast').click(); },
                'Enter': () => { document.getElementById('btn-reel').click(); }
            };
            
            if (keyMap[e.key]) {
                e.preventDefault();
                keyMap[e.key]();
            }
        });
        
        // ===== å•Ÿå‹• =====
        connect();
        
        console.log('ğŸ£ é‡£é­šé™æ§å™¨å·²å•Ÿå‹•');
    </script>
</body>
</html>
